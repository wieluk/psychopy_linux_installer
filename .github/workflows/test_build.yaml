name: Run PsychoPy Installer on Multiple Linux OS with build option

on:
  workflow_run:
    workflows: ["Run PsychoPy Installer on Multiple Linux OS"]
    types:
      - completed
  workflow_dispatch:

jobs:
  run-installer:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: [self-hosted, "${{ matrix.os }}"]
    strategy:
      matrix:
        os: [ubuntu-24.04, ubuntu-22.04, ubuntu-20.04, debian-12, debian-11, fedora-39, fedora-40, pop-22.04, rocky-9.4, centos-9, manjarolinux-24, opensuse-leap-15.6, linuxmint-22]
        python_version: ['3.10.14']
        psychopy_version: ['latest']
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
      
      - name: Prepare environment
        run: |
          sudo chmod +x $GITHUB_WORKSPACE/psychopy_linux_installer
          sudo rm -rf /tmp_dir
          sudo mkdir /tmp_dir
          sudo chown -R $USER:$(id -gn $USER) /tmp_dir
          cp -rf $GITHUB_WORKSPACE/.github/PsychoPy_tests /tmp_dir/

      - name: Run PsychoPy Linux Installer
        id: run-installer
        continue-on-error: true
        run: |
          ARGS="--python-version=${{ matrix.python_version }} --psychopy-version=${{ matrix.psychopy_version }} --additional-packages=psychopy_bids,seedir --install-dir=/tmp_dir/psychopy --no-versioned-install-dir --force --build=both --sudo-mode=auto"
          $GITHUB_WORKSPACE/psychopy_linux_installer $ARGS
        
      - name: Verify PsychoPy installation and version
        id: verify-psychopy
        continue-on-error: true
        run: |
          if ! /tmp_dir/psychopy/bin/psychopy -h &> /dev/null; then
            echo "PsychoPy help command failed"
            exit 1
          fi
          
          if ! /tmp_dir/psychopy/bin/psychopy -v | grep -qE "PsychoPy3, version [0-9]+\.[0-9]+\.[0-9]+"; then
            echo "PsychoPy version check failed"
            exit 1
          fi

      - name: run basic PsychoPy test
        id: psychopy-test
        continue-on-error: true
        run: |
          cd /tmp_dir/PsychoPy_tests
          /tmp_dir/psychopy/bin/python /tmp_dir/PsychoPy_tests/psychopy_test.py 2>&1 | tee /tmp_dir/PsychoPy_tests/psychopy_test.log
          set -e
          if ! tail -n 1 /tmp_dir/PsychoPy_tests/psychopy_test.log | grep -qE "Trial 3: Elapsed time .* seconds"; then
            echo "::error::PsychoPy test output verification failed"
            exit 1
          fi

      - name: Run extended PsychoPy Tests
        id: psychopy-test-extended
        continue-on-error: true
        run: |
          output=$(/tmp_dir/psychopy/bin/python /tmp_dir/PsychoPy_tests/psychopy_test_extended.py)
          tests=("Visual" "Keyboard" "Image" "Timing")
          for test in "${tests[@]}"; do
            if ! echo "$output" | grep -qE "${test} Test Passed"; then
              echo "::error::${test} Test Failed"
              exit 1
            fi
          done
          echo "All tests passed successfully."

      - name: Verify BIDS installation simple
        id: verify-bids
        continue-on-error: true
        run: |
          cd /tmp_dir/PsychoPy_tests/BIDS
          if ! /tmp_dir/psychopy/bin/python bids_test_simple.py; then
            echo "::error::BIDS simple test execution failed"
            exit 1
          fi
    
      - name: Verify BIDS installation exp_handler
        id: verify-bids-handler
        continue-on-error: true
        run: |
          cd /tmp_dir/PsychoPy_tests/BIDS
          if ! /tmp_dir/psychopy/bin/python bids_test_exp_handler.py; then
            echo "::error::BIDS exp_handler test execution failed"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          sudo rm -rf /tmp_dir ~/Desktop/* ~/.local/share/applications/*